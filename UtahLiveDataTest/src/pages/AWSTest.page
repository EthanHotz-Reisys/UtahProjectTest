<apex:page showHeader="false" sidebar="false" cache="false" controller="AWS_Upload" standardStylesheets="false">
    <style>
        form {
          padding: 20px;
          border: 1px solid #cccccc;
          border-radius: 10px;
          -moz-border-radius: 10px;
          -webkit-box-shadow: 0 0 10px #ccc;
          -moz-box-shadow: 0 0 10px #ccc;
          box-shadow: 0 0 10px #ccc;
          background-image: -moz-linear-gradient(top, #ffffff, #f2f2f2);
          background-image: -webkit-gradient(linear, left top, left bottom, from(#ffffff), to(#f2f2f2));
        }

        #mainContent {
          width: 99%;
          float: left;
          margin-left: 0px;
          overflow: hidden;
          padding-top: 0px;
        }

        h4.fileToUpload {
          margin-top: 0.0em;
          font-size: 16pt;
        }
        h1, h2, h3, h4, h5, h6 {
          color: #00396B;
          margin-top: 1.5em;
          margin-bottom: 0.3em;
          font-family: Arial, Helvetica, sans-serif;
        }
        .row {
          padding-bottom: 5px;
        }
        input {
          border: 1px solid #ccc;
          font-size: 16px;
          padding: 5px 10px 5px 10px;
          border-radius: 10px;
          -moz-border-radius: 10px;
          -webkit-transition: all 0.5s ease-in-out;
          -moz-transition: all 0.5s ease-in-out;
          transition: all 0.5s ease-in-out;
        }
        input[type=submit]{
          opacity: 1.0;
          color: #fff;
          background-image: -moz-linear-gradient(top, #4c90b5, #4c90b5);
          background-image: -webkit-gradient(linear, left top, left bottom, from(#4c90b5), to(#4c90b5));
          cursor: pointer;
        }
    </style> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <div id="mainContent">
        <form action="https://s3.amazonaws.com/{!awsKeySet.Name}" method="post" enctype="multipart/form-data" id="uploadForm">
            <input type="hidden" name="key" id="key" />
            <input type="hidden" name="AWSAccessKeyId" value="{!awsKeySet.AWS_AccessKey_Id__c}" />
            <input type="hidden" name="policy" value="{!policy}" />
            <input type="hidden" name="signature" value="{!signedPolicy}" />
            <input type="hidden" name="acl" value="{!acessType}" />
            <input type="hidden" name="Content-Type" value="{!Content_Type}" />
            <input type="hidden" name="success_action_redirect" value="{!ForRedirect}" />
            <h4 class="fileToUpload">Select a File to Upload</h4><br/>
            <div class="row">
                <input type="file" size="50" name="file" id="file" accept=".xlsx" />
            </div><br/>
            <div class="row">
                <input type="submit" value="Upload" id="btn_submit" />
            </div>
        </form>
    </div>

    <script>
        $(document).ready(function() {
            $("#btn_submit").click(function(event) {
                event.preventDefault();
                if( document.getElementById("file").files.length == 0 ){
                    alert("Please select a file to upload.");
                }else{
                    var _file;
                    _file = $("#file").val().replace(/.+[\\\/]/, "");
                   //guid = (S4() + S4() + "-" + S4() + "-4" + S4().substr(0, 3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
                    var ext = _file.substring(_file.lastIndexOf("."));
                    if(ext===".xlsx"){
                        var rawFileName = _file.substring(_file.lastIndexOf("/")+1);
                        var newFileName = "{!$CurrentPage.parameters.id}" + ext;
                        var financialBatch = {
                          rawFileName : rawFileName,
                          internalFileName: newFileName
                        }
                        updatePOC(financialBatch);
                        //makeAPICall();
                        $("#key").val(newFileName);
                        $("#uploadForm").submit();
                    }else{
                        alert("Please select a .xlsx file");
                    }
                }
            }); 
        });

        function S4() {
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }

        function updatePOC(financialBatch) {
            var pocid = "{!$CurrentPage.parameters.id}";
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.AWS_Upload.updateBacthAndCallAPI}',
                pocid,
                financialBatch.internalFileName,
                financialBatch.rawFileName,               
                function(result, event) {
                    if (event.status) {

                    } else if (event.type === 'exception') {

                    } else {

                    }
                }, {
                    escape: true
                }
            );
        }

        /*function makeAPICall() {
            var pocid = "{!$CurrentPage.parameters.id}";
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.AWS_Upload.makeAPICall}',
                pocid,             
                function(result, event) {

                    if (event.status) {

                    } else if (event.type === 'exception') {

                    } else {

                    }
                }, {
                    escape: true
                }
            );
        }*/
    </script>
     
</apex:page>