<apex:page showHeader="false" sidebar="false" cache="false" controller="AWS_Upload" standardStylesheets="false">

    <style>
        form {
          padding: 20px;
          border: 1px solid #cccccc;
          border-radius: 10px;
          -moz-border-radius: 10px;
          -webkit-box-shadow: 0 0 10px #ccc;
          -moz-box-shadow: 0 0 10px #ccc;
          box-shadow: 0 0 10px #ccc;
          background-image: -moz-linear-gradient(top, #ffffff, #f2f2f2);
          background-image: -webkit-gradient(linear, left top, left bottom, from(#ffffff), to(#f2f2f2));
        }
        #mainContent {
          width: 99%;
          float: left;
          margin-left: 0px;
          overflow: hidden;
          padding-top: 0px;
        }
        h4.fileToUpload {
          margin-top: 0.0em;
          font-size: 16pt;
        }
        h1, h2, h3, h4, h5, h6 {
          color: #7F3300;
          margin-top: 1.5em;
          margin-bottom: 0.3em;
          font-family: DaxCompact-RegularRegular, Georgia, Helvetica, Times, 'Times New Roman' , serif;
        }
        .row {
          padding-bottom: 5px;
        }
        input {
          border: 1px solid #ccc;
          font-size: 16px;
          padding: 5px 10px 5px 10px;
          border-radius: 10px;
          -moz-border-radius: 10px;
          -webkit-transition: all 0.5s ease-in-out;
          -moz-transition: all 0.5s ease-in-out;
          transition: all 0.5s ease-in-out;
        }
        input[type=submit]{
          opacity: 1.0;
          background-image: -moz-linear-gradient(top, #ffffff, #dfdfdf);
          background-image: -webkit-gradient(linear, left top, left bottom, from(#ffffff), to(#dfdfdf));
          cursor: pointer;
        }
    </style>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.138.0.min.js"></script>
    <div id="mainContent">
        <form id="theForm" method="POST" enctype="multipart/form-data" >
            <input id="theFile" name="file" type="file"/> 
            <button id="theButton" type="submit">send 1</button>
        </form>
    </div>
    
    <script>
        $(function() {
        
            $('#theForm').on('submit', sendFile);
        });
        
        function sendFile(e) {
            e.preventDefault();
        
            var s3 = new AWS.S3({
                accessKeyId: '{!awsKeySet.AWS_AccessKey_Id__c}',
                secretAccessKey: '{!awsKeySet.AWS_AccessKey_Id__c}'
            });
        
            var _file;
            _file = $("#theFile").val().replace(/.+[\\\/]/, "");
            guid = (S4() + S4() + "-" + S4() + "-4" + S4().substr(0, 3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();
            var ext = _file.substring(_file.indexOf("."));
            var newFileName = guid + ext;
        
            var tempUrl = s3.getSignedUrl('putObject', {
                Bucket: '{!awsKeySet.Name}',
                Key: newFileName,
                ACL: 'authenticated-read',
                // This must match with your ajax contentType parameter
                ContentType: 'binary/octet-stream'
        
                /* then add all the rest of your parameters to AWS puttObect here */
            });
        
            tempUrl = tempUrl.replace('govgrantsassets.', '');
            var uploadPreSignedUrl = tempUrl.replace('.com/', '.com/govgrantsassets/')
            console.log('previous url', uploadPreSignedUrl);
            
            // get the reference to the actual file in the input
            var theFormFile = $('#theFile').get()[0].files[0];
        
            $.ajax({
                    type: 'PUT',
                    url: uploadPreSignedUrl,
                    // Content type must much with the parameter you signed your URL with
                    contentType: 'binary/octet-stream',
                    // this flag is important, if not set, it will try to send data as a form
                    processData: false,
                    // the actual file is sent raw
                    data: theFormFile,
                	signatureVersion: 'v4'
                })
                .success(function() {
                    alert('File uploaded');
                })
                .error(function() {
                    alert('File NOT uploaded');
                    console.log(arguments);
                });
        
            return false;
        }  

        function S4() {
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        }
    
    </script>
     
</apex:page>