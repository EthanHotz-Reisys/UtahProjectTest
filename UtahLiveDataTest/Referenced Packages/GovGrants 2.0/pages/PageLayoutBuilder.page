<apex:page sidebar="false" controller="GNT.PageLayoutBuilder" applyBodyTag="false" docType="html-5.0" showHeader="false" standardStylesheets="false">
    
    <c:ExternalLibrary /> 
    <link href="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/css/pagelayoutbuilder.css')}" rel="stylesheet" /> 
    <link href="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/css/step-progress.css')}" rel="stylesheet" /> 
    
    <apex:composition template="GNT__PageTemplate"> 
        <apex:define name="content">         
            <div id="page-content-wrapper" class="page-content-wrapper page-content-wrapper-ext">                       
                <div id="pagelayoutbuilder" ng-controller="PageLayoutBuilderCtrl" ng-cloak="true" class="container-fluid main-container">                                   
                    <div class="row content">
                        <div ng-class="{'col-md-2': step == 1, 'hidden': step == 3 || step == 2}" class="pallete-bar">
                            <div class="row">
                                <div class="col-sm-12">                                                                
                                    <div class="search-span"><input type="text" ng-model="search.name" placeholder="Search..." class="form-control full-width" /></div>   
                                </div>
                            </div>
                            <div class="row full-height">
                                <div class="col-sm-12 available-fields full-height">
                                    <ul id="available-fields" handler="sortableHandler" sortable="angular" 
                                            helper="clone" class="connectedSortable available-fields">
                                        <li ng-class="{'disabled-li':disabledFieldsMap[field.fieldAPIName] == true}" 
                                            class="ui-state-highlight avail-li" id="{{field.fieldAPIName}}" 
                                            name="{{field.fieldAPIName}}" 
                                            ng-repeat="field in availableFields | filter: search.name"
                                            ng-style="{'margin-left': field.level*15 + 'px'}">                                            
                                            <span class="cursor-pointer field-icon-span">
                                                <i ng-if="field.dataType == 'REFERENCE'" ng-click="getReferenceFields(field,$index,field.level+1)" class="fa fa-plus" aria-hidden="true"></i>
                                                <i ng-if="field.dataType != 'REFERENCE'" class="fa fa-minus" aria-hidden="true"></i>
                                            </span>
                                            <span class="field-label-span" ng-bind="field.fieldLabel"/>
                                        </li>                                        
                                    </ul>   
                                </div>
                            </div>                            
                        </div>
                        <div ng-class="{'col-md-10': step == 1, 'col-md-12': step == 3 || step == 2 }" class="canvas-area">  
                            <div class="row">
                                <!-- <div class="col-md-9">
                                    <div class="save-changes-div" ng-if="unsavedChanges">
                                        Please save your changes to allow editing of properties.
                                    </div>
                                </div> -->
                                <div class="col-md-12">
                                    <div class="menu-bar pull-right">
                                        <a ng-if="step == 1" id="btn-new-section" href="#" class="btn" ng-click="saveLayout()">Save and Next</a>
                                        <a ng-if="step == 2 || step == 3" id="btn-new-section" href="#" class="btn" ng-click="goToPrevStep()">Previous</a>
                                        <a ng-if="step == 2" id="btn-new-section" href="#" class="btn" ng-click="goToNextStep()">Next</a>                                        
                                    </div>
                                </div>
                            </div>                          
                            <div class="row">
                                <div class="col-md-12">
                                    <ul class="progress-indicator">
                                        <li ng-class="{'completed':step == 2 || step ==3, 'active':step == 1}">
                                            <span class="bubble"></span>
                                            Setup form<br/><!-- <small>(complete)</small> -->
                                        </li>
                                        <li ng-class="{'completed':step == 3, 'active':step == 2, '':step == 1}">
                                            <span class="bubble"></span>
                                            Edit properties<br/><!-- <small>(in progress)</small> -->
                                        </li>
                                        <li ng-class="{'active':step == 3, '' : step == 1 || step == 2}">
                                            <span class="bubble"></span>
                                            Preview<br/><!-- <small>(pending)</small> -->
                                        </li>
                                        <!-- <li class="active">
                                            <span class="bubble"></span>
                                            Step 4.
                                        </li>
                                        <li>
                                            <span class="bubble"></span>
                                            Step 5.
                                        </li> -->
                                    </ul>
                                </div>                                
                            </div>
                            <!-- {{formConfig}} -->
                            <div class="row">
                                <div class="col-md-12">
                                    <ul  
                                        class="pageBlock-ul" 
                                        ng-repeat="tabConfig in formConfig.tabConfigList">
                                        <div ng-if="step == 1" class="tab-menu-bar">
                                            <a id="btn-new-section" class="btn" href="#" ng-click="openNewPageBlockModal(tabConfig)">
                                                <i class="fa fa-plus" aria-hidden="true"></i> &nbsp; Add new section
                                            </a>
                                        </div>
                                        <div pbsortable="angular" handler="sortableHandler" class="connectedPageBlockSortable page-blocks">
                                            <li class="pageBlock-li" parentname="{{tabConfig.id}}"  index="{{pageBlockConfig.index}}" 
                                                ng-repeat="pageBlockConfig in tabConfig.pageBlockConfigList">
                                                <div class="panel panel-default tab-content">
                                                    <div class="panel-heading pb-div panel-title">
                                                        <span ng-bind="pageBlockConfig.title"></span>
                                                        <span ng-if="step == 2" class="pb-actions pull-right">
                                                            <a href="#" ng-click="openPageBlockModal(pageBlockConfig);"><span><i class="fa fa-cog" aria-hidden="true"></i></span></a>
                                                            <a href="#"><span><i class="fa fa-trash-o" aria-hidden="true"></i></span></a>
                                                        </span>
                                                    </div>
                                                    <div class="panel-body">
                                                        <ul name="{{pageBlockConfig.id}}" handler="sortableHandler" 
                                                            sortable="angular" helper="original" ng-class="" 
                                                            class="connectedSortable selected-fields {{pageBlockConfig.columns}}">                                        
                                                            <li class="sel-li" ng-click="openModal(pageBlockDetailConfig);" 
                                                                label="{{pageBlockDetailConfig.fieldInfo.fieldLabel}}" 
                                                                parentname="{{pageBlockConfig.id}}" 
                                                                name="{{pageBlockDetailConfig.fieldInfo.fieldAPIName}}" 
                                                                ng-repeat="pageBlockDetailConfig in pageBlockConfig.pageBlockDetailConfigList">                                            
                                                                <div class="pbd-div" ng-class="{'pbd-div-preview':step == 3}">                                                
                                                                    <fieldholder pbd-config="pageBlockDetailConfig" pbd-handler="pbdHandler"/>    
                                                                </div>
                                                            </li>                                                                    
                                                        </ul>
                                                    </div>
                                                </div>
                                            </li>
                                        </div>
                                    </ul>
                                </div>
                            </div>                                                                                                                                    
                        </div>
                    </div>
                    <div  id="pageBlockModalDiv" class="modal fade bgColor-black" role="dialog" 
                                data-backdrop="static" tabindex="0" onkeyup="setFocusOnCloseModal()">
                        <div class="modal-dialog">
                            <!-- Modal content --> 
                            <div class="modal-content">
                                <div class="modal-header modal-header-ext">
                                    <button type="button" id="pageBlockModalDivCloseIcon" class="close close-ext" 
                                        data-dismiss="modal" tabindex="0" aria-label="Close" >
                                            &times; <span class="hidden508">Close</span><span class="hidden-offscreen">
                                            Edit</span>
                                    </button>
                                    <p class="modal-title">Edit</p>
                                </div>
                                <div class="modal-body">                                       
                                    <iframe id="pageBlockModalDiviframeContentId" class="modal-iframe" 
                                        ng-src="{{modalURL}}" frameborder="0" 
                                            marginheight="0" marginwidth="0" scrolling="auto" height="500" style="height:500px !important"/>                       
                                </div>                       
                            </div>
                        </div>
                    </div>
                    <div  id="pageBlockDetailModalDiv" class="modal fade bgColor-black" role="dialog" 
                                data-backdrop="static" tabindex="0" onkeyup="setFocusOnCloseModal()">
                        <div class="modal-dialog">
                            <!-- Modal content --> 
                            <div class="modal-content">
                                <div class="modal-header  modal-header-ext">
                                    <button type="button" id="pageBlockDetailModalDivCloseIcon" class="close close-ext" 
                                        data-dismiss="modal" tabindex="0" aria-label="Close" >
                                        &times; <span class="hidden508">Close</span>
                                        <span class="hidden-offscreen">Edit</span>
                                    </button>
                                    <p class="modal-title">Edit</p>
                                </div>
                                <div class="modal-body">     
                                    <iframe id="pageBlockDetailModalDiviframeContentId" class="modal-iframe" 
                                        ng-src="{{modalURL}}" frameborder="0" 
                                            marginheight="0" marginwidth="0" scrolling="auto" height="500" style="height:500px !important" />                                              
                                </div>                       
                            </div>
                        </div>
                    </div> 
                    <div  id="newPageBlockModalDiv" class="modal fade bgColor-black" role="dialog" 
                                data-backdrop="static" tabindex="0" onkeyup="setFocusOnCloseModal()">
                        <div class="modal-dialog">
                            <!-- Modal content --> 
                            <div class="modal-content">
                                <div class="modal-header  modal-header-ext">
                                    <button type="button" id="pageBlockDetailModalDivCloseIcon" class="close close-ext" 
                                        data-dismiss="modal" tabindex="0" aria-label="Close" >
                                        &times; <span class="hidden508">Close</span>
                                        <span class="hidden-offscreen">New Page Block</span>
                                    </button>
                                    <p class="modal-title">New Page Block</p>
                                </div>
                                <div class="modal-body">     
                                    <form>
                                        <div class="form-group">
                                            <label for="title">Title</label>
                                            <input type="text" ng-model="newPageBlock.title" class="form-control" id="title" placeholder="Title" />
                                        </div>
                                        <div class="form-group">
                                            <label for="columns">Fields per row</label>
                                            <select ng-model="newPageBlock.bodyColumnSize" class="form-control">
                                                <option>1</option>
                                                <option>2</option>
                                                <option>3</option>
                                                <option>4</option>
                                            </select>                                            
                                        </div>
                                        <button type="submit" ng-click="addNewSection()" class="btn btn-default">OK</button>
                                    </form>                                              
                                </div>                       
                            </div>
                        </div>
                    </div>  
                </div>            
            </div>              
         </apex:define> 
    </apex:composition>
   
    <script type="text/javascript">
        Array.prototype.move = function (old_index, new_index) {
            if (new_index >= this.length) {
                var k = new_index - this.length;
                while ((k--) + 1) {
                    this.push(undefined);
                }
            }
            this.splice(new_index, 0, this.splice(old_index, 1)[0]);
            return this; // for testing purposes
        };

        j$( document ).ready( function(){
            
            j$( ".content" ).css( "height", ( j$( window ).height() - j$('.footer').height() -15) + "px" );   
            j$( ".page-blocks" ).css( "height", ( j$( window ).height() - j$('.footer').height() -240) + "px" );            

        });
        function closeIframe(a,b){
            console.log('a------',a);
            console.log('b------',b);
            console.log('------',angular.element(document.getElementById('pagelayoutbuilder')).scope());
            angular.element(document.getElementById('pagelayoutbuilder')).scope().closeModalAndRefresh();
        }
    </script>
    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/services.js')}"/>
    <script>
        

        _RemotingPageLayoutBuilderActions = {};
        _RemotingPageLayoutBuilderActions.GetSetupInfo= '{!$RemoteAction.PageLayoutBuilder.getSetupInfo}';
        _RemotingPageLayoutBuilderActions.SaveLayout= '{!$RemoteAction.PageLayoutBuilder.saveLayout}';
        _RemotingPageLayoutBuilderActions.GetFields= '{!$RemoteAction.PageLayoutBuilder.getFields}';


        var pageLayoutId = '{!$CurrentPage.parameters.pageLayoutId}';
        var sobjectConfigId = '{!$CurrentPage.parameters.sobjectConfigId}';
        var isView = '{!$CurrentPage.parameters.isView}';
        var pageLayoutBuilderApp = angular.module('pagelayoutbuilder', ['sharedServices','ui.field']);    
            
    </script>

    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/autosuggest.js')}"/>
    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/field.js')}"/>
    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/controller.js')}"/>
    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/helper.js')}"/>
    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/directive.js')}"/>
    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/field-sortable.js')}"/>
    <script type="text/javascript" src="{!URLFOR($Resource.GovGrants, 'Pages/PageLayoutBuilder/js/pageBlock-sortable.js')}"/>
    
    <script>        
        angular.element(document).ready(function() {
            angular.bootstrap(document.getElementById('pagelayoutbuilder'),['pagelayoutbuilder']);    
        });        
    </script>
</apex:page>